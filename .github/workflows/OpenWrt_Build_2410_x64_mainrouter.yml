name: OpenWrt_Build_2410_x64_mainrouter

permissions:
  contents: write

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: 30 1 * * *

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: config/2410_x64_mainrouter.config
  DIY_P1_SH: diy_script/2410_x64_mainrouter_diy-part1.sh
  DIY_P2_SH: diy_script/2410_x64_mainrouter_diy-part2.sh
  FILE_NAME: OpenWrt_2410_x64_mainrouter
  PRODUCT_NAME: x86_64
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  OpenWrt_Build_2410_x64_mainrouter:
    name: ç¼–è¯‘OpenWrt_Build_2410_x64_mainrouter
    runs-on: ubuntu-24.04

    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUåž‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
        echo -e "CPUåž‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: æœ€å¤§åŒ–æž„å»ºç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 8192
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d
        sudo bash -c "curl -skL https://raw.githubusercontent.com/sbwml/actions/openwrt-build-setup/sources-24.04.list > /etc/apt/sources.list"
        sudo rm -rf /etc/apt/sources.list.d* /usr/local/lib/android* /etc/docker* /etc/firefox* /etc/mysql* /etc/php* /opt/google* /usr/share/dotnet* /usr/share/google* /usr/share/moby* /usr/share/mysql* /usr/share/php*
        sudo -E apt-get -qq update
        sudo -E apt-get -y purge azure* docker* dotnet* firefox* ghc* google* llvm* mongodb* mysql* php* powershell* snap* gfortran* microsoft-edge-stable
        sudo -E apt-get -qq install $(curl -fsSL raw.githubusercontent.com/Lai-xi/Actions-Lede_x86/main/run)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: å¼ºåˆ¶æ¸…ç†ç£ç›˜
      run: |
        sudo rm -rf /mnt/*
        sudo rm -rf /opt/*
        sudo rm -rf /usr/local/*
        df -hT

    - name: å…‹éš†æºä»£ç 
      # working-directory: $GITHUB_WORKSPACE
      run: |
        df -hT $PWD
        git clone --single-branch --depth=1 --filter=blob:none $REPO_URL -b $REPO_BRANCH $GITHUB_WORKSPACE/openwrt
        echo "OPENWRT_PATH=$GITHUB_WORKSPACE/openwrt" >> $GITHUB_ENV

    - name: ç”Ÿæˆå˜é‡
      run: |
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(cat openwrt/.config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(cat openwrt/.config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV

    - name: åŠ è½½è‡ªå®šä¹‰è½¯ä»¶æº
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°è½¯ä»¶æº
      run: cd openwrt && ./scripts/feeds update -a

    - name: å®‰è£…è½¯ä»¶æº
      run: cd openwrt && ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: ç¼“å­˜å·¥å…·é“¾
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: true
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å‰æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: ç¼–è¯‘åŽæ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: |
        echo "=========================================="
        echo "----------------ç©ºé—´ä½¿ç”¨-------------------"
        echo "=========================================="
        echo "ç³»ç»Ÿç©ºé—´       ç±»åž‹   æ€»æ•°  å·²ç”¨  å¯ç”¨ ä½¿ç”¨çŽ‡"
        df -hT
        echo "=========================================="
        du -h --max-depth=1 openwrt/ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 openwrt/build_dir
        du -h --max-depth=1 openwrt/bin

    - name: ä¸Šä¼  bin ç›®å½•
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: ${{ env.FILE_NAME }}-${{ env.KERNEL }}-bin-${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        echo "KERNEL=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ')" >> $GITHUB_ENV
        mv openwrt-x86-64-generic-squashfs-combined.img.gz ${{ env.FILE_NAME }}-${{ env.FILE_DATE }}-bios.img.gz
        mv openwrt-x86-64-generic-squashfs-combined-efi.img.gz ${{ env.FILE_NAME }}-${{ env.FILE_DATE }}-uefi.img.gz
        rm -rf config.buildinfo
        rm -rf feeds.buildinfo
        rm -rf openwrt-x86-64-generic-kernel.bin
        rm -rf openwrt-x86-64-generic-squashfs-rootfs.img.gz
        rm -rf openwrt-x86-64-generic.manifest
        rm -rf profiles.json
        rm -rf version.buildinfo
        rm -rf sha256sums
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@v4
      if: ${{ env.UPLOAD_FIRMWARE == 'true' && steps.organize.outputs.status == 'success' && !cancelled() }}
      with:
        name: ${{ env.FILE_NAME }}-${{ env.KERNEL }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: ${{ env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled() }}
      run: |
        : > "$GITHUB_OUTPUT"  # æ¸…ç©ºæ—§è¾“å‡ºï¼Œé¿å…é‡å¤è§¦å‘æ—§å˜é‡
        release_tag=$(date +"%Y.%m.%d-%H.%M")
        release_date=$(date +"%Y-%m-%d %H:%M")
        echo "release_tag=$release_tag" >> "$GITHUB_OUTPUT"
        echo "release_date=$release_date" >> "$GITHUB_OUTPUT"
        echo "status=success" >> "$GITHUB_OUTPUT"
        # ðŸ”½ æ·»åŠ å‘å¸ƒé¡µè¯´æ˜Ž
        echo "  ### ðŸ“’ å›ºä»¶ä¿¡æ¯ ðŸ“’ ###  " >> release.txt
        echo "ðŸŽ¯ å›ºä»¶åç§°: ${{ env.FILE_NAME }}" > release.txt
        echo "ðŸ“… ç¼–è¯‘æ—¶é—´: $release_date" >> release.txt
        echo "âš™ï¸ æž„å»ºé…ç½®: $CONFIG_FILE" >> release.txt
        echo "ðŸ’» å¹³å°æž¶æž„: x86_64 " >> release.txt
        echo "ðŸ§± å›ºä»¶æºç : ${{ env.REPO_URL }} " >> release.txt
        echo "ðŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }} " >> release.txt
        echo "ðŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }} " >> release.txt
        echo "ðŸŒ é»˜è®¤åœ°å€ï¼š192.168.18.1 " >> release.txt
        echo "ðŸ§‘â€ðŸ’¼ é»˜è®¤è´¦å·ï¼šroot " >> release.txt
        echo "ðŸ”‘ é»˜è®¤å¯†ç ï¼šæ— å¯†ç  " >> release.txt
        echo "----------------------------------------" >> release.txt
        echo "âš½ ç¼–è¯‘æ—¥å¿—è¯·æŸ¥çœ‹ Actions æž„å»ºè¯¦æƒ…" >> release.txt

    - name: ä¸Šä¼ å›ºä»¶è‡³Release
      uses: softprops/action-gh-release@v2
      if: ${{ env.UPLOAD_RELEASE == 'true' && steps.tag.outputs.status == 'success' && !cancelled() }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: ${{ env.FILE_NAME }}
        tag_name: ${{ env.FILE_NAME }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
